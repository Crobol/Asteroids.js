<!DOCTYPE html>
<html>
	<head>
		<script src="pixi.dev.js"></script>
		<script src="keydrown.js"></script>
	</head>
	<body>
        <p style="position: absolute; color: #00FF00;">Kills: <span id="kills"/> </p>
		<script src="QuadTree.js"></script>
		<script src="asteroids.js"></script>
		<script src="Component.js"></script>
		<script src="GraphicsComponent.js"></script>
		<script src="MovementComponent.js"></script>
		<script src="InputComponent.js"></script>
		<script src="CollisionComponent.js"></script>
		<script src="HealthComponent.js"></script>
		<script src="WrapAroundComponent.js"></script>
		<script src="AttackComponent.js"></script>
		<script src="LifetimeComponent.js"></script>
		<script src="FrictionComponent.js"></script>
        <script src="EntityTemplates.js"></script>
		<script>
			"use strict";

            if (debug)
                console.log("Starting asteroids...");

            var worldDimensions = new Vector(700, 400);

            var kills = 0;

            if (debug)
                console.log("Setting world dimensions to " + worldDimensions.x + "x" + worldDimensions.y);

			var componentManager = new ComponentManager();

            componentManager.messageHub.registerCallback('entityKilled', function (message) { 
                    kills = kills + 1; 
                    document.getElementById('kills').innerHTML = kills;
                    console.log(message.entityType + " killed");
                });

            if (debug)
                console.log("Creating components...");

			var graphicsComponent = new GraphicsComponent(componentManager.messageHub, worldDimensions);
			var movementComponent = new MovementComponent(componentManager.messageHub);
			var inputComponent = new InputComponent(componentManager.messageHub);
			var collisionComponent = new CollisionComponent(componentManager.messageHub, worldDimensions);
			var healthComponent = new HealthComponent(componentManager.messageHub);
			var wrapAroundComponent = new WrapAroundComponent(componentManager.messageHub, worldDimensions);
			var attackComponent = new AttackComponent(componentManager.messageHub);
			var lifetimeComponent = new LifetimeComponent(componentManager.messageHub);
			var frictionComponent = new FrictionComponent(componentManager.messageHub);

			componentManager.addComponent(inputComponent);
			componentManager.addComponent(attackComponent);
			componentManager.addComponent(movementComponent);
			componentManager.addComponent(frictionComponent);
			componentManager.addComponent(collisionComponent);
			componentManager.addComponent(healthComponent);
			componentManager.addComponent(wrapAroundComponent);
			componentManager.addComponent(graphicsComponent);
			componentManager.addComponent(lifetimeComponent);
            
            componentManager.entityFactory.addEntityTemplate("player", playerTemplate);
            componentManager.entityFactory.addEntityTemplate("asteroid", asteroidTemplate);

            var player = componentManager.entityFactory.createEntityFromTemplate("player");
            player.position.x = worldDimensions.x / 2;
			player.position.y = worldDimensions.y / 2;

			for (var i = 0; i < 5; i++) {
				var asteroid = componentManager.entityFactory.createEntityFromTemplate("asteroid");
                componentManager.entities.push(asteroid); // TODO: Get rid of this. Component manager should not know about entities

				asteroid.position.x = Math.random() * worldDimensions.x;
				asteroid.position.y = Math.random() * worldDimensions.y;
				asteroid.rotation = Math.random() * Math.PI * 2;

				asteroid.movement.xVel = Math.random() * 5 - 2.5;
				asteroid.movement.yVel = Math.random() * 5 - 2.5;

				asteroid.graphics.color = Math.round(Math.random() * 16777215);

                var edges = 3 + Math.round(Math.random() * 5);
                var unit = 2 * Math.PI / edges;
                for (var j = 0; j < edges; j++) {
                    asteroid.graphics.model.push({x: 20 * Math.cos(unit * j), y: 20 * Math.sin(unit * j)});
                }
			}

requestAnimFrame(function () { componentManager.update(function () { graphicsComponent.renderQuadtree(collisionComponent.quadtree); }); });
		</script>
	</body>
</html>
